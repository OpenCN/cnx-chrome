<script src="jquery.js"></script>
<script src="data/defaults.js"></script>
<script>
var cnx = {
	data: {
		se: JSON.parse(localStorage.se),
		te: JSON.parse(localStorage.te),
		get: function(path){
			var obj = cnx.data;
			path.forEach(function(k){ obj = obj[k]; });
			return obj;
		},
		set: function(path, val){
			var obj = cnx.data, first = path[0], last = path.pop();
			path.forEach(function(k){ obj = obj[k]; });
			obj[last] = val;
			
			if (first === "se" || first === "te") { localStorage[first] = JSON.stringify(cnx.data[first]); }
		}
	}
};

$.getJSON("data/rows.json", function(j){ cnx.data.rows = j; });

chrome.extension.onRequest.addListener(function(req, sender, send){
	if ("get" in req) {
		send(cnx.data.get(req.get));
	} else if ("set" in req) {
		cnx.data.set(req.set, req.val);
		send(true);
	}
});

chrome.tabs.onUpdated.addListener(function(id, changeinfo, tab){
	var cn = tab.url.match(/^http:\/\/(www|tournament)\.cybernations\.net/i);
	if (cn) {
		chrome.pageAction.setIcon({ tabId: id, path: "icons/19-" + (cn[1] === "www" ? "se" : "te") + ".png" });
		chrome.pageAction.show(id);
	}
});
</script>