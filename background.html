<script src="jquery.js"></script>
<script src="data/defaults.js"></script>
<script>
var cnx = {
	data: {
		se: JSON.parse(localStorage.se),
		te: JSON.parse(localStorage.te),
		get: function(path, v){
			var o = cnx.data, pa = path.split(".");
			if (v) { o = o[v]; }
			pa.forEach(function(k){ o = o[k]; });
			return o;
		},
		set: function(path, val, v){
			if (v) {
				var o = cnx.data[v], pa = path.split("."), l = pa.pop();
				pa.forEach(function(k){ o = o[k]; });
				o[l] = val;
				localStorage[v] = JSON.stringify(cnx.data[v]);
			} else {
				cnx.data[path] = val;
			}
		}
	}
};

chrome.extension.onRequest.addListener(function(r, sender, send){
	if ("get" in r) {
		send(cnx.data.get(r.get, r.v));
	} else if ("set" in r) {
		cnx.data.set(r.set, r.val, r.v);
		send(true);
	}
});

chrome.tabs.onUpdated.addListener(function(id, changeinfo, tab){
	var m = tab.url.match(/^http:\/\/(www|tournament)\.cybernations\.net/i);
	if (m) {
		chrome.pageAction.setIcon({ tabId: id, path: "icons/19-" + (m[1] === "www" ? "se" : "te") + ".png" });
		chrome.pageAction.show(id);
	}
});

$.getJSON("data/rows.json", function(j){ cnx.data.rows = j; });
</script>