<script src="jquery.js"></script>
<script src="data/defaults.js"></script>
<script>
var cnx = {
	data: {
		se: JSON.parse(localStorage.se),
		te: JSON.parse(localStorage.te),
		get: function(path, ver){
			var o = cnx.data, pa = path.split(".");
			if (ver) { o = o[ver]; }
			pa.forEach(function(k){ o = o[k]; });
			return o;
		},
		set: function(path, val, ver){
			if (ver) {
				var o = cnx.data[ver], pa = path.split("."), l = pa.pop();
				pa.forEach(function(k){ o = o[k]; });
				o[l] = val;
				localStorage[ver] = JSON.stringify(cnx.data[ver]);
			} else {
				cnx.data[path] = val;
			}
		}
	}
};

chrome.extension.onRequest.addListener(function(req, sender, send){
	if ("get" in req) {
		send(cnx.data.get(req.get, req.ver));
	} else if ("set" in req) {
		cnx.data.set(req.set, req.val, req.ver);
		send(true);
	}
});

chrome.tabs.onUpdated.addListener(function(id, changeinfo, tab){
	var cn = tab.url.match(/^http:\/\/(www|tournament)\.cybernations\.net/i);
	if (cn) {
		chrome.pageAction.setIcon({ tabId: id, path: "icons/19-" + (cn[1] === "www" ? "se" : "te") + ".png" });
		chrome.pageAction.show(id);
	}
});

$.getJSON("data/rows.json", function(j){ cnx.data.rows = j; });
</script>